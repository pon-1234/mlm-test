## フローチャートの前提

- フロントエンドは管理用のWeb UI（React/Next.js）
- バックエンドはNestJSによるAPIサーバ
- データストアはMySQL
- 権限認証済みユーザ（管理者オペレータ）が操作
- 代表的な機能（会員登録、組織チェック、検索、報酬計算、返金処理）を盛り込む

---

## アプリケーション上位フローチャート例

```
 ┌───────────────────┐
 │   管理UI（React）  │
 └───────┬─────────┘
         │ (1) ログイン・認証要求
         v
 ┌───────────────────┐
 │  APIサーバ(NestJS)│
 │  認証コントローラ   │
 └───────┬─────────┘
         │ JWT検証 / DB問い合わせ(users, user_roles)
         │ 正常ならJWT発行
         v
     [認証成功]
         │
         │ (2) トップページ表示、メニュー選択
         v
 ┌───────────────────┐
 │  会員管理機能UI     │
 └───────┬─────────┘
         │ (3)「会員登録」画面へ遷移
         v
  ユーザ入力：基本情報、紹介者、ポジション等
         │ (4)「登録」ボタン押下 -> API呼び出し
         v
 ┌───────────────────────────┐
 │ APIサーバ: /members POST   │
 └───────┬──────────────────┘
         │ 入力検証: class-validator
         │ 組織整合性チェック（introducer_id, upline_id の循環確認）
         │ DB登録(members, member_positions)
         v
      [登録完了/レスポンス]
         │
         v
 ┌───────────────────┐
 │  フロント:登録完了  │
 └───────┬─────────┘
         │ (5) 結果表示「会員ID:xxx登録完了」
         │ (ユーザが次の操作を行う)
         v
   ┌────────────────────────┐
   │  会員検索画面へ遷移     │
   └─────────┬──────────┘
             │ (6) 検索条件入力→API呼び出し
             v
        ┌────────────────────────────┐
        │ APIサーバ: GET /members?query=... │
        └───────────────────┬─────────┘
                            │ DB検索(members, member_positions)
                            v
                      [検索結果リストJSON]
                            │
                            v
                   ┌───────────────────┐
                   │ フロント：検索結果表示 │
                   └───────┬─────────┘
                           │ (7) ユーザが対象会員を選択し詳細閲覧
                           v
                ┌───────────────────────────┐
                │ 会員詳細表示画面(タブ切替)    │
                └───────┬─────────────────┘
                        │  基本情報タブ: GET /members/{id}
                        │  組織図タブ: 組織API呼出、D3.jsで表示
                        │  購入履歴タブ: GET /orders?member_id=...
                        │  報酬履歴タブ: GET /member_commissions?member_id=...
                        │  ...
                        v
               [詳細情報表示完了]

                         ┌──────────────────────┐
                         │  報酬計算作業(管理者)   │
                         └─────────┬─────────┘
                                   │ (8) 報酬計算期間選択→「計算実行」ボタン
                                   v
                   ┌─────────────────────────────────┐
                   │ APIサーバ: POST /commissions/calculate?period_id=... │
                   └───────────────────┬────────────────────┘
                                       │ 報酬計算ロジック実行:
                                       │ 1. 組織構造取得 (organization_relationships)
                                       │ 2. 売上取得 (orders)
                                       │ 3. 各報酬プラン適用 (commission_plans)
                                       │ 4. 結果をmember_commissions, commission_details へINSERT
                                       v
                                [計算完了レスポンス]
                                       │
                                       v
                      ┌──────────────────────────────┐
                      │ フロント：計算結果一覧表示       │
                      └───────────┬────────────────┘
                                  │ (9) 必要ならCSV出力
                                  v
                          [CSVダウンロード開始]
                                  │
                                  v
                        ┌───────────────────┐
                        │ ファイル保存→分析用外部ツール  │
                        └───────────────────┘

           ┌─────────────────────┐
           │  返金処理（クーリングオフ） │
           └─────────┬─────────┘
                       │ (10)対象注文選択し「返金処理」ボタン
                       v
            ┌───────────────────────────────────┐
            │ APIサーバ: POST /refunds (order_id, amount...) │
            └──────────────────┬─────────────────┘
                               │ DB更新(refunds, refund_line_items)
                               │ 該当注文に紐づく報酬再計算処理(commission_details再計算)
                               │ member_commissions差分調整
                               v
                        [返金＆再計算結果レスポンス]
                               │
                               v
                    ┌────────────────────────┐
                    │ フロント：「返金完了」メッセージ表示 │
                    └────────────────────────┘

```

---

## ポイント

1. **認証フロー**
    
    ログイン時にユーザー情報を検証し、JWTを発行。その後のAPIアクセス時にJWTヘッダを検証。
    
2. **会員登録フロー**
    
    ユーザが管理画面で会員情報を入力→APIサーバで組織整合性チェック→DB登録。
    
3. **会員検索・参照フロー**
    
    検索条件をフロントで入力→APIでDB検索→結果一覧表示→詳細画面へ遷移して各種タブ情報を別々のAPIで取得。
    
4. **報酬計算フロー**
    
    計算期間を選択→バックエンドで報酬ロジック実行→計算結果をDBへ→フロントで結果一覧表示・CSV出力。
    
5. **返金・クーリングオフ対応フロー**
    
    対象注文指定→バックエンドで返金登録＆報酬差戻し計算→結果をフロントへ返し表示。
    

---