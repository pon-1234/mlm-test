## 1. 概要

本システムは、MLM（マルチレベルマーケティング）組織の会員管理、組織構造可視化、報酬計算、商品管理、注文・出荷・返金管理、調整金処理など、多岐にわたる業務をサポートするWebアプリケーションである。現在は主に管理者・オペレーターが利用する内部システムを想定しているが、将来的にエンドユーザー（会員）自身が利用するポータルサイトを拡張可能なアーキテクチャとする。

## 2. 全体アーキテクチャ構成図

```
                      ┌──────────────────────────┐
                      │        End Users          │
                      │ (将来の会員用フロント)     │
                      └─────────┬────────────────┘
                                │ HTTPS
                                │
                 ┌───────────────────────────────────┐
                 │           user-frontend            │
                 │  (Next.js, React, TS)              │
                 └─────────────────┬─────────────────┘
                                   │ HTTPS(API)
                                   │
┌──────────────────────────────────┴──────────────────────────────────┐
│                            backend (NestJS)                          │
│       ┌────────────────┬────────────────┬─────────────────┐        │
│       │auth             │members         │organization      │        │
│       │(JWT発行,        │(会員管理共通) │(組織整合性)      │        │
│       │ admin/user両用) │                │                  │        │
│       ├────────────────┼────────────────┼─────────────────┤        │
│       │commissions      │orders          │products          │        │
│       │(報酬計算)       │(注文・出荷・   │(商品マスタ)       │        │
│       │                 │  返金管理)     │                  │        │
│       ├────────────────┼────────────────┼─────────────────┤        │
│       │admin            │support         │reports           │        │
│       │(管理者専用API)  │(問い合わせ管理)│(PDF/CSV出力)      │        │
│       └────────────────┴────────────────┴─────────────────┘        │
│                                 │                                   │
│                           DB(MySQL)                                 │
│         (members, orders, commissions, products, adjustments...)     │
└─────────────────────────────────────────────────────────────────────┘

                                   │
                      ┌──────────────────────────┐
                      │       admin-frontend      │
                      │  (Next.js, React, TS)     │
                      │   (管理者・オペレータ用)  │
                      └──────────────────────────┘

```

## 3. 各レイヤと役割

- **End User Frontend (user-frontend)**：
    
    将来会員が利用するポータルサイト。会員向けにログイン、報酬履歴参照、自分の注文履歴確認、問い合わせ投稿などを行う。
    
    認証には会員向けJWTを利用し、自分自身のデータのみアクセス可能。
    
- **Admin Frontend (admin-frontend)**：
    
    管理者・オペレーター用フロントエンド。既存通り、会員検索や組織再編、報酬計算、商品登録など全体管理権限を持つ機能を提供。
    
- **Backend (NestJS)**：
    
    共通APIサーバとして機能する。
    
    - `auth`モジュール：管理者用、会員用の2種類のJWTを発行・検証し、アクセスコントロールを行う。
    - `members`, `organization`, `orders`, `products`, `commissions`などのモジュールは、基本的に共通データアクセスロジックやビジネスロジックを提供し、フロントエンドが管理者・会員いずれであっても同一APIで対応可能（認可ロジックでデータ範囲を制限）。
    - `admin`モジュール：管理者権限専用のAPIエンドポイントを提供（例：全会員一覧ダンプ、他人の情報編集、報酬計算実行など）。
    - `support`, `reports`など汎用的な機能は、ユーザー種別に応じたアクセス制御を行い、会員自身は自分の問い合わせのみ参照可能、管理者は全件参照可能などの差異をAPIレベルで実装。
- **Database (MySQL)**：
    
    スキーマは共通で、会員/注文/報酬/商品などすべてのデータを一元管理。
    
    アクセス権限はアプリケーションロジックによって制御し、DB自体は共通のソースとして機能する。
    

## 4. 認証・認可モデル

### 4.1 ロール定義

1. 管理者ロール（admin）
    - すべての機能にアクセス可能
    - 他の会員の情報参照・編集が可能
    - 報酬計算実行や組織変更などの特権操作が可能
2. オペレータロール（operator）
    - 日常的な運用作業に必要な機能にアクセス可能
    - 会員情報の参照と一部編集が可能
    - 特権操作（報酬計算実行など）は不可
3. 会員ロール（user）
    - 自分自身の情報のみ参照可能
    - 自分の直下の組織構造のみ参照可能
    - 他の会員の情報は参照不可

### 4.2 認証方式

1. JWT（JSON Web Token）による認証
    - トークン内に以下の情報を含む：
        - ユーザID/会員ID
        - ロール情報
        - 有効期限
        - その他必要なクレーム
2. トークン管理
    - アクセストークンの有効期限は短め（例：2時間）
    - リフレッシュトークンによる自動更新
    - ログアウト時にはトークンを無効化

### 4.3 認可制御

1. API単位の認可チェック
    - 各APIエンドポイントで必要なロールを定義
    - JWTに含まれるロール情報に基づき制御
    - 例：
        
        ```tsx
        @Roles('admin', 'operator')
        @Get('/members/:id')
        async getMember(@Param('id') id: string) {
          // 管理者・オペレータのみアクセス可能
        }
        
        ```
        
2. データアクセス制御
    - 会員ロール（user）の場合：
        - GET /members/:id → 自分のIDと一致する場合のみ許可
        - GET /organization/tree → 自分をルートとする下位組織のみ参照可能
        - GET /commissions → 自分の報酬情報のみ参照可能
    - 管理者/オペレータの場合：
        - アクセス制限なし（ロールに応じた制御）
3. エラーハンドリング
    - 認証エラー：401 Unauthorized
    - 認可エラー：403 Forbidden
    - エラーレスポンス例：
        
        ```json
        {
          "error": "FORBIDDEN",
          "message": "この操作を実行する権限がありません",
          "details": {
            "required_role": "admin",
            "current_role": "user"
          }
        }
        
        ```
        

### 4.4 セキュリティ対策

1. トークンセキュリティ
    - JWTの署名検証
    - トークンの有効期限管理
    - セッションの無効化機能
2. アクセス制御
    - CORS設定による許可オリジンの制限
    - レート制限の実装
    - 不正アクセスの検知と遮断
3. データ保護
    - センシティブ情報の暗号化
    - パスワードのハッシュ化
    - 通信の暗号化（HTTPS）

### 4.5 フロントエンド連携

1. admin-frontend（管理者用）
    - すべての機能にアクセス可能
    - 特権操作の実行が可能
    - 他の会員の情報を参照・編集可能
2. user-frontend（会員用）
    - 自分の情報のみ参照可能
    - 機能制限：
        - 組織図：自分以下の階層のみ表示
        - 報酬情報：自分の情報のみ表示
        - 注文履歴：自分の注文のみ表示
    - 編集機能の制限：
        - 基本情報の一部のみ編集可能
        - 組織構造の変更は不可
        - 報酬関連の操作は参照のみ

### 4.6 API設計指針

1. エンドポイント設計
    - 管理者専用API：/admin/... プレフィックス
    - 共通API：認可制御により制限
    - 会員用API：自動的に会員ID制限を適用
2. パラメータ検証
    - 会員IDの一致確認
    - ロールに基づく操作制限
    - 不正なパラメータのブロック
3. レスポンス設計
    - エラーメッセージの標準化
    - 権限エラーの明確な表示
    - デバッグ情報の適切な制御

### 4.7 監視・監査

1. アクセスログ
    - 認証・認可の成功/失敗を記録
    - 重要な操作の実行記録
    - 不正アクセスの検知
2. 監査証跡
    - データ変更の履歴保持
    - 操作者の特定
    - 変更内容の詳細記録

## 5. 技術スタックと今後の拡張性

- **フロントエンド**：
    
    共通してNext.js + React + TypeScriptを利用する方針。
    
    将来、エンドユーザー向けフロントエンドにはブランドテーマ、UIデザインをカスタムできる。
    
    2つのフロントエンド間で共通UIコンポーネントがあれば`libs`ディレクトリを設けて共有可能。
    
- **バックエンド**：
    
    NestJS + TypeScript + TypeORMを継続使用。
    
    会員・注文・報酬計算ロジックは共通処理で、認可ロジックのみ拡張。
    
- **デプロイ・インフラ**：
    
    admin-frontendとuser-frontendを別々のサブドメイン（例：`admin.example.com`、`user.example.com`）でホスティング可能。
    
    CI/CDパイプラインは2つのフロントエンドを独立ビルド・デプロイし、バックエンドは共通で運用。
    
    スケールアウトはフロントエンド・バックエンドともにコンテナ化(AWS ECS/GCP GKE)、CDN、ロードバランサを適用可能。
    

## 6. 拡張時の考慮点

- **UI拡張**：
    
    user-frontend追加時、既存のバックエンドAPIを再利用できる。
    
    会員向け機能を拡張する場合、既存`members`や`orders`モジュールにロール別認可ロジックを加える。
    
    必要に応じて`user-frontend`専用のAPI Endpointも`backend`内に増設可能(ただし共通モジュールで処理することを推奨)。
    
- **認可ロジックの拡張**：
    
    将来的にロールが増えたり（スーパーバイザー、ビューワーなど）、一部機能を有料会員のみ利用可能にするなどの場合、`auth`モジュールおよびガード、デコレーターを拡張し、柔軟なポリシーを適用できる。
    
- **可観測性と監査**：
    
    エンドユーザー用UIが増えた場合、アクセス数増加が見込まれるため、ロギング（winston/pino）、APM（Datadog、New Relic）、監査ログの充実化などで保守性・可観測性を高める。
    

## 7. まとめ

現行アーキテクチャ（管理者向けUI + バックエンド + DB）に、将来エンドユーザー向けUIを追加する場合も、基本的なAPIやスキーマは共通化され、ロールベース認可とサブドメイン分離により拡張に対応可能である。

これにより、組織運用者向け、会員向けの両視点でシステムを提供しつつ、共通インフラ・ロジック・スキーマを最大限再利用できる構造を実現する。

---