07.追加修正仕様

## 1. 会員管理モジュール

### 1.1 会員登録機能

### 1.1.1 概要

- 新規会員を登録する機能。
- **活動開始シーズン(start_season)は不要**となりました。
- *口数（positions_count）**を追加で入力可能。
    - 1口目が基本ポジション。2口目以降も同一人物の「直紹介」扱いとし、バイナリーの左右系列に順次配置される。
- バイナリー組織として、**直紹介者にすでに2人配置されている場合は新たに紹介できない**制御を行う。

### 1.1.2 入力項目

| 項目名 | 型 | 必須 | 検証/制約 | 画面表示 | 入力例 |
| --- | --- | --- | --- | --- | --- |
| 氏名(name) | string | 必須 | 1〜100文字 | テキスト | "山田 太郎" |
| メールアドレス(email) | string | 任意 | Email形式, 200文字以内 | テキスト | "[taro@example.com](mailto:taro@example.com)" |
| 電話番号(phone) | string | 任意 | 数字・ハイフン許容、50文字以内 | テキスト | "03-1234-5678" |
| 郵便番号(postal_code) | string | 必須 | 半角英数字,20文字以内 | テキスト | "100-0001" |
| 住所1(address_line1) | string | 必須 | 1〜255文字 | テキスト | "東京都千代田区..." |
| 住所2(address_line2) | string | 任意 | 0〜255文字 | テキスト |  |
| 市区町村(city) | string | 必須 | 1〜100文字 | テキスト | "千代田区" |
| 都道府県(state_province) | string | 必須 | 1〜100文字 | セレクト | "東京都" |
| 国(country) | string | 必須 | 1〜100文字 | テキスト | "日本" |
| 契約締結日(contract_date) | date | 必須 | YYYY-MM-DD形式 | 日付選択 | "2024-01-01" |
| 紹介者ID(introducer_id) | number | 通常必須(rootメンバーのみNULL可) | - 既に直下が2名いる会員は指定不可- DB上に存在するmember_id | テキスト/検索 | "10001" |
| 口数(positions_count) | number | 任意 | 1〜(上限は運用次第) | 数値 | 1, 2, 3... |
| 契約プラン(contract_plan) | string | 必須 | プラン定義済マスタテーブル参照(ビジネス会員/代理店会員など) | セレクト | "business" |
| 振込先口座情報(bank_xxx) | 複数項目 | 必須 | 銀行名、支店名、口座種別、口座番号、名義必須 | テキスト | "三菱UFJ", etc. |
| (※活動開始シーズンは削除) | - | - | 本仕様から除外 | - | - |

### 1.1.3 処理フロー

1. `POST /members` でリクエスト受領
2. バリデーション
3. 組織整合性チェック
    - rootメンバー( introducer_id=NULL )は1名のみOK
    - 通常メンバー：introducerの直下が2名未満か確認。すでに2名いればエラー
    - 循環参照チェック
4. `members`テーブルへINSERT（クーリングオフフラグ初期値=OFFなど）
5. 住所や口座情報をそれぞれINSERT
6. *口数(positions_count)**をもとに複数ポジション生成
    - 1口目：introducer_id に紐づいて`member_positions`作成
    - 2口目以降：自分自身の基本ポジションを紹介者とみなし、左右に1人ずつ追加可能（バイナリー制御）
    - `organization_relationships` テーブルに (parent_member_id, child_member_id, depth=1) を追加
7. 成功レスポンス

### 1.1.4 エラーハンドリング

- バイナリー直下が埋まっている場合：400 Bad Request
「指定された紹介者は2系列が埋まっており、新たに登録できません。」
- rootメンバー重複：400 Bad Request
- 循環参照エラー
- DBエラー：500 Internal Server Error

---

### 1.2 会員検索機能

*(従来通り、変更点なし)*

---

### 1.3 組織整合性チェック機能

### バイナリー特有の追加制御

- **直紹介者が2名を超えてはならない**
    - `organization_relationships` や `member_positions` を参照し、直下が既に2名いる場合は登録エラー。
- 従来同様、rootメンバーは1名のみ、循環チェックも行う。

---

### 1.4 会員情報参照/更新

### 追加・変更項目

1. **会員状態に「クーリングオフ」トグル**
    - active, inactiveなどに加え、`cooling_off` フラグを持たせるか、あるいはstatusに`cooloff`等を追加。
2. **オート購入タブ**
    - 会員詳細に「オートリピート購入」の設定/履歴を確認するタブを追加。
    - ボーナスが一定額(20,000円超)に達した際に自動購入が発動中かどうかを表示/更新。

---

## 2. 組織図機能

### 2.1 組織図表示

### 追加表示要件

- **左側と右側の「登録人数」およびレベル数**を表示
    - 例：左系列に合計何人いるか、最先端が何段目かを算出し表示。
    - 右系列にも同様に表示。
- シンプルなカウント例：
    - `SELECT COUNT(*) FROM organization_relationships WHERE parent_member_id = X AND ~ left系判定 ...` (実装方法は環境次第)

---

## 3. 報酬計算モジュール

### 3.1 ボーナスプラン概要

### （1）紹介ボーナス

- **発生条件**: 直接紹介者がビジネス or 代理店で新規登録した場合
- **ビジネス会員登録**: 1件につき 5,000円
- **支払いタイミング**: 登録翌週金曜締め → 翌々週金曜支払い

### （2）レベルマッチボーナス

- **左右の系列**で1:1人数がマッチするとレベルごとに5,000円
- **支払いタイミング**: 同上（翌週金曜締め → 翌々週金曜支払い）
- **メガマッチ**: 直紹介 or 2レベル下がレベルマッチを受け取るとその20% (1,000円) が上位に支給

### （3）バイナリーボーナス

- **左右の売上の少ない方×8%**
- **支払いタイミング**: 月末締め → 翌月20日支払い
- **月間上限**: 1ポジション50万円
- **バイナリーメガマッチ**: 直紹介 or 2レベル下のバイナリーボーナス10%を上位に支給

### （4）シェアボーナス

- **紹介人数に応じたポイント制**：会社の売上の一部(3% + 余剰分)が原資
- 前期(12〜5月) → 6/15支払
- 後期(6〜11月) → 12/15支払