## MLMシステム開発設計

## 1. 会員管理モジュール

### 1.1 会員登録

**機能概要**:

新規会員を登録し、紹介者IDを必須項目として扱う。

登録時に組織ループを自動チェックして不整合を防ぐ。

**登録情報**:

- 基本情報：受付日、契約締結日、氏名、住所、連絡先（電話・メールアドレス）
- 金融情報：振込先口座情報（報酬支払い用）
- ポジション情報：紹介者ID（必須）、活動開始シーズン、契約プラン（報酬プラン種別や契約タイプ）

**チェック項目**:

- 紹介者のループチェック：`organization_relationships`テーブルを使用して循環関係発生時はエラー表示
- 紹介者の存在確認：指定された紹介者IDが有効な会員であることを確認

**期待効果**:

不正な上下関係や循環構造を防ぎ、報酬計算や組織図表示を安定化。

**仕様ポイント**:

- 紹介者IDは必須入力項目。
- 登録後の組織変更では管理者権限で承認フローを通じて更新し、再度整合性チェックを実行。
- `organization_relationships`テーブルで組織構造を管理し、柔軟な組織変更に対応。

### 1.2 会員検索

**機能概要**:

会員ID、氏名、住所、紹介者ID、契約日、活動ステータス、配置ポジションなど複数条件で検索。

検索結果はCSVエクスポート可能。

### 1.3 各種チェック機能（整合性検証）

**機能概要**:

組織構造の整合性を検証し、循環参照や不正な構造を防止する。

**チェック種別**:

1. 新規会員登録時のチェック
    - 紹介者の存在確認
    - 紹介者からの上位方向への循環参照チェック
    - `organization_relationships`テーブルを使用した効率的な検証
2. 組織異動時のチェック
    - 異動元会員の下位ツリー全体を把握
    - 異動先が下位ツリーに含まれていないことを確認
    - 異動による新しい構造が循環を作らないことを保証

**実装方針**:

1. データ構造
    - `organization_relationships`テーブルによるclosure table方式
    - `parent_member_id`, `child_member_id`, `depth`の組み合わせで効率的な検索を実現
    - 複合インデックスによるパフォーマンス最適化
2. 検証ロジック
    - 再帰CTEまたはclosure table検索による循環検出
    - 大規模組織に対応するためのクエリ最適化
    - キャッシュ戦略の採用（必要に応じて）
3. エラーハンドリング
    - 明確なエラーメッセージと詳細情報の提供
    - フロントエンドでのユーザーフレンドリーな表示
    - ログ記録による追跡可能性の確保

**パフォーマンス対策**:

- インデックス最適化
- クエリのチューニング
- 必要に応じたキャッシュ導入
- バッチ処理による定期的な整合性検証

**監視と通知**:

- 整合性チェックの実行結果を監視
- 問題検出時の管理者通知
- 定期的な全体構造の検証

### 1.4 会員情報参照/更新

**機能概要**:

会員詳細画面で下記タブを用意し、情報参照・編集対応。

- 会員情報タブ：基本情報・振込先口座編集
- ポジション情報タブ：申込日、活動開始シーズン、紹介者情報、契約プラン編集
- 購入履歴タブ：購入伝票履歴参照・新規伝票登録フォーム
- 定期購入設定タブ：定期購買商品の編集、支払方法設定、購買サイクル設定
- 組織図タブ：ビジュアルな組織図で会員位置を表示
- 紹介リストタブ：該当会員が紹介した下位会員一覧表示
- アップラインリストタブ：上位階層を一覧表示
- ボリューム情報タブ：紹介数、ポイント、売上合計、アクティビティ状況表示
- 報酬履歴タブ：計算済み報酬一覧・明細出力機能
- 調整金履歴タブ：加算・減算した調整金の履歴表示
- お問い合わせ履歴タブ：サポート部門とのやり取り履歴表示

### 1.5 組織関係変更機能

**概要**:

組織再編・誤登録修正時に上下関係を変更可能。

変更時には再度循環・整合性チェック実行。

報酬再計算などへの影響考慮。

変更操作は管理者権限のみ実行可能で、変更履歴を監査ログに記録。

---

## 2. 組織図機能

### 2.1 マップ表示

**機能概要**:

MLM組織を高パフォーマンスなUIで表示。

全体図表示、過去比較、画像保存、ズーム、ドリルダウン、会員検索連動、過去組織履歴参照、カスタム表示（色分け・表示情報追加）など対応。

**ユーザビリティ**:

マウスオーバーで会員ボリューム情報ツールチップ表示。

---

## 3. 報酬計算モジュール

### 3.1 報酬計算前チェック

**機能概要**:

報酬計算前にノンアクティブ会員や不整合チェックを行い、計算精度を向上。

### 3.2 報酬計算処理

**機能概要**:

ユニレベル、バイナリー、リーダーボーナスなど複数プラン対応。

多階層構造での報酬分配を自動計算。

タイトル別報酬率など条件対応。

### 3.3 集計情報表示

**機能概要**:

計算結果に基づく会員数、ポジション数、売上合計など集計情報一覧化。

月次・週次レポート作成を補助。

### 3.4 支払調書出力

**機能概要**:

報酬・手数料・契約金・賞金の支払調書をPDF出力。

会計・税務対応可能。

### 3.5 振込データ出力

**機能概要**:

インターネットバンキング、ファームバンキング、送金代行会社向けのフォーマットで振込データ出力。

振込明細PDF出力もサポート。

### 3.6 返金・クーリングオフ時の報酬再調整機能

**機能概要**:

返金発生時の報酬調整を自動化し、関連する全会員の報酬を適切に再計算・調整する。

**処理種別**:

1. 全額返金（クーリングオフ等）
    - 対象注文に紐づく全ての報酬を無効化
    - 関連する全会員の報酬から該当分を差し引き
    - 支払済みの場合は次回報酬からの相殺または調整金として処理
2. 部分返金
    - 返金額の比率に応じて報酬を減額
    - 計算式：返金調整額 = 既存報酬額 × (返金額 ÷ 注文合計額)
    - 商品単位での返金にも対応（返金対象商品の報酬のみ調整）

**自動化範囲**:

1. 返金情報の登録
    - 返金ヘッダ・明細の登録
    - 返金理由や対象商品の記録
    - 返金状態の管理
2. 報酬への影響計算
    - 直接の報酬受給者の報酬再計算
    - 上位者ボーナスの再計算
    - 組織全体への影響の把握
3. 調整処理の実行
    - 未払い報酬の場合：報酬額の直接修正
    - 支払済み報酬の場合：負の調整金登録
    - ネガティブバランスの管理

**データ管理**:

1. 返金記録
    - `refunds`：返金取引の基本情報
    - `refund_line_items`：返金対象商品の明細
    - 返金理由や承認者などの監査情報
2. 報酬調整記録
    - `commission_details`：報酬明細の更新履歴
    - `adjustments`：調整金の記録
    - 調整理由や計算根拠の明確化
3. 履歴管理
    - 返金から報酬調整までの一連の処理を追跡可能
    - 監査ログによる変更履歴の保持
    - レポート出力機能での可視化

**運用上の考慮事項**:

1. パフォーマンス
    - 大規模な報酬再計算の効率的な処理
    - バックグラウンドジョブによる非同期処理
    - 処理状態の可視化
2. データ整合性
    - トランザクション管理による一貫性確保
    - エラー発生時のロールバック処理
    - 二重処理の防止
3. 通知・アラート
    - 大規模な返金処理の管理者承認
    - 処理完了・エラー発生時の通知
    - 異常値検知時のアラート
4. レポーティング
    - 返金影響額の集計
    - 報酬調整履歴の照会
    - 監査用データの出力

---

## 4. 調整金モジュール

### 4.1 調整金登録

**機能概要**:

報酬に対する加算/減算調整金を登録・編集。

単票入力・CSVインポート対応。

キャンペーンボーナス付与、返金時のマイナス調整などに対応。

### 4.2 調整金検索・出力

**機能概要**:

条件抽出しCSV出力可能。

報酬計算や追跡を容易に。

---

## 5. 商品管理モジュール

### 5.1 商品登録・編集

**機能概要**:

商品名、商品コード、価格、在庫、販売期間を管理。

新規注文・定期購入画面への表示制御可能。

### 5.2 商品検索・出力

**機能概要**:

条件検索可能、CSV出力対応。

商品戦略立案に活用。

---

## 6. データ入出力（インポート/エクスポート）

### 6.1 インポート可能データ

- 調整金データ
- 出荷実績データ

### 6.2 エクスポート可能データ

- 会員データ
- 伝票データ
- 商品データ
- 振込データ
- 出荷データ
- 送り状データ

### 6.3 カスタマイズ性

必要に応じデータ項目拡張。

会計、在庫システム連携に柔軟対応。

---

## 運用上の考慮事項

- **権限管理・監査ログ**:
    
    ロールベースアクセス制御を実施（管理者、オペレータ、会員）。
    
    重要操作（組織変更、調整金登録、報酬計算実行など）はすべて監査ログテーブルに記録。
    
- **報酬計算サイクル管理**:
    
    月次または週次計算サイクルでバッチ実行。
    
    計算前チェック、計算後調整、支払い処理をワークフロー化。
    
- **外部連携**:
    
    振込データ、払調書、商品・出荷データのエクスポートで外部会計・物流・顧客管理システムと連携。
    
- **返金・クーリングオフ対応**:
    
    クーリングオフ期間設定と返金自動処理でトラブル軽減。
    
    返金発生時に報酬自動再計算・調整。
    
- **将来のエンドユーザー利用**:
    
    現在は管理者/オペレータ用だが、将来会員向けフロントエンド(user-frontend)を拡張し、会員自身が報酬履歴や購入履歴を閲覧可能なポータルを提供。